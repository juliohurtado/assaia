@startuml
skinparam monochrome true
skinparam shadowing false
skinparam activity {
  BackgroundColor #f8f9fa
  BorderColor #495057
  ArrowColor #343a40
}
skinparam activityFontSize 13

title Security Access & Queue Assignment API - Backend Flow

start

partition "API Gateway" {
  :Receive HTTP Request;

  if (Valid API Key?) then (yes)
    :Route to endpoint;
  else (no)
    #LightCoral:Return 401 Unauthorized;
    stop
  endif
}

partition "POST /security-access/sessions" {
  :Create Session (UUID);
  :Store in Database;
  :Return Session + Expiry;
}

partition "POST .../sessions/{id}/scan" {
  :Validate Session exists;
  :Parse BCBP Payload;

  if (Parse OK?) then (yes)
    :Extract Flight Info;
    :Link to Session;
    :Return ScanResult;
  else (no)
    #LightCoral:Return 400 Bad Request;
    stop
  endif
}

partition "POST .../sessions/{id}/decision" {
  :Validate Session + Scan exists;

  group "Context Enrichment"
    :Fetch Flight Status (AODB Adapter);
    :Fetch Lane Status (Queue Adapter);
  end group

  group "Business Rules"
    if (Flight Valid Today?) then (yes)
      if (Within Access Window?) then (yes)
        :Continue;
      else (no)
        :reasonCode = TOO_EARLY;
        :result = DENY;
        stop
      endif
    else (no)
      :reasonCode = FLIGHT_EXPIRED;
      :result = DENY;
      stop
    endif
  end group

  group "Lane Assignment Algorithm"
    if (Passenger = PRM?) then (yes)
      :Assign PRM_ASSISTED lane;
    else if (Minutes to Departure < 45?) then (yes)
      :Assign FAST_TRACK lane;
    else (default)
      :Assign STANDARD (Load Balanced);
    endif
  end group

  :Return AccessDecision;
  note right
    result: ALLOW
    laneAssignment: {...}
    reasonCode: OK
  end note
}

partition "POST .../sessions/{id}/gate/open" {
  :Validate gateCommandId (Idempotency);
  :Log Audit Event;
  :Return 204 No Content;
}

partition "POST /security-access/events" {
  :Validate Event Payload;
  :Store in Event Log;
  :Return 202 Accepted;
}

stop
@enduml
